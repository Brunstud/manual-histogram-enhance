# 作业总结

## 一、本次任务目标

本次作业的核心任务是：下载并处理 ImageNet 数据集中的三个类目（猫、老鼠、拖拉机），对图像进行亮度增强，包括统一尺寸、实现多种直方图增强方法（equalize、clahe、stretch、gamma），并保存增强图像与直方图图像，最后进行效果分析与对比。

## 二、项目模块与实现流程

我将项目分成多个模块化脚本完成，主要包括：

* `download_imagenet.py`：从 ImageNet 下载指定 synset 的 .tar 文件，并完成解压
* `image_io/`：负责图像加载、保存、RGB↔YCrCb 转换、图像 resize（最近邻与双线性插值）
* `enhancement/`：分别实现四种亮度增强方法（手工实现）
* `histogram/`：统计 Y 通道直方图，绘制增强前后的直方图图像
* `main.py`：主流程，加载图像、执行增强、保存结果和直方图对比图

整个流程设计模块清晰、职责明确，便于后期扩展或更换算法实现。

## 三、遇到的问题与解决方式

整个项目做下来，一步一步解决了许多细节。我们从图像下载开始，每一步几乎都踩了坑。最开始只下了一个类目的图，发现图像总数不够，后来换成多个类目搭配，才把总图像量凑够。而且下载下来后图像尺寸五花八门，有的上千像素、有的只有几十像素，想直接处理肯定不行，于是开始考虑怎么 resize。

一开始选的是 256×256，因为网上很多例子都是这个尺寸，但后来一想，既然我们统计了所有图像的宽高面积，能不能直接算一个“平均面积”的等效边长？于是就按照均值面积开方，定了一个 446×446 的 resize 标准。

接下来是在 resize 的插值方法上纠结。一开始用最近邻插值，虽然快，但图像边缘锯齿感特别明显，后来看了资料和效果图，决定换成双线性插值，平滑效果肉眼可见地好了不少。

图像增强这部分也是从“先试试调库”过渡到“完全手工实现”，中间最大的转折是 RGB 和 Y 通道的处理。我们最开始直接在 RGB 图像上做直方图增强，结果输出图颜色完全变了，看起来像是加了灰滤镜，后来才意识到 JPEG 编码的核心在 Y 通道，图像增强应该作用在亮度上，颜色信息应该保持不变。

CLAHE 算法的实现中也踩了不少坑，比如一开始直接把每个 tile 块增强后拼起来，结果图像边界出现了很多断层感，看着特别不自然。于是参考双线性插值的原理，做了四邻域 LUT 插值融合，这个思路一加进去，图像平滑很多。还有 tile 大小时的问题，原本设定每个 tile 是固定尺寸，后来发现图像尺寸不能整除 tile size 的时候就会出问题，干脆反过来固定 tile 数量，每个 tile 的大小由图像尺寸自动算，这样就避免了裁剪或边角残缺。

clip limit 这个参数也非常关键，如果不限制，增强效果很容易把局部噪声拉得很亮，反而模糊了整体结构。调整 clip limit 后就稳定很多。

除了算法层面的坑，还有一堆和库版本相关的东西，比如 Pillow 版本不兼容，Image.ANTIALIAS 被弃用了，得换成 Image.Resampling.LANCZOS；还有些 JPEG 图像本身就是损坏的，加载的时候直接崩了，为了防止一张图挂掉整个流程，就给处理流程加了 try-except 做兜底。

最后还有一个比较隐蔽但很关键的问题，就是图像增强之后保存时，只保存了 Y 通道，结果图像变成了灰度图，调了半天发现是没有把增强后的亮度通道和原始的 CrCb 色彩通道合并，补上这个重建步骤后，彩色图像才恢复正常。

## 四、收获与反思

通过这个项目，我从头到尾实践了一次图像增强任务的完整流程。很多原本以为是“调函数”的操作，自己真正实现一遍后才明白其中的原理和细节。比如怎么将 RGB 图像提取亮度信息、怎么重建色彩图像、怎么手动写插值函数、怎么统计直方图并生成映射表……每一个看起来简单的图像操作背后其实都涉及了大量细节，只有真正动手写过之后才知道。

整个过程中，我们不仅学会了怎么提升图像亮度，还学会了怎么控制图像增强的“尺度感”，避免过度提升导致的失真。还通过不断调参和修复 bug，逐渐把整个 pipeline 打磨得越来越稳定。
